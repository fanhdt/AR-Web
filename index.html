<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Aplikasi AR Berbasis Lokasi</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- AR.js dan Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.2.2/aframe-ar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.2.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>

    <style>
      .ar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
      }

      .location-info {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        padding: 1rem;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        z-index: 20;
      }
    </style>
  </head>
  <body class="m-0 p-0 overflow-hidden">
    <!-- A-Frame Scene -->
    <a-scene vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">
      <!-- Kamera dengan atribut GPS -->
      <a-camera gps-camera="minDistance: 0; maxDistance: 50000" rotation-reader look-controls-enabled="false" arjs-look-controls="smoothingFactor: 0.1" id="camera"> </a-camera>

      <!-- Template untuk POI (Point of Interest) -->
      <a-entity id="places-container"></a-entity>
    </a-scene>

    <!-- UI Overlay -->
    <div class="location-info bg-blue-900 bg-opacity-70 text-white p-4">
      <div id="location-display" class="text-sm">Mencari lokasi...</div>
      <div id="bearing-display" class="text-sm">Menghitung arah...</div>
    </div>

    <!-- Indikator Jarak -->
    <div id="distance-indicators" class="ar-overlay"></div>

    <script>
      // Data POI (Points of Interest) - Contoh dari kode Java asli
      const POIs = [
        { name: "Rumah Irfan", lat: -6.9867784, lon: 107.6457581, altitude: 684.30 },
        { name: "Linh Ung Pagoda", lat: 16.1072989, lon: 108.2343984, altitude: 0 },
      ];

      // Variabel untuk lokasi pengguna
      let userLocation = null;
      let userHeading = 0;
      let watchId = null;

      // Inisialisasi aplikasi
      window.onload = () => {
        initializeApp();
      };

      function initializeApp() {
        // Mulai melacak lokasi pengguna
        startLocationTracking();

        // Tambahkan event listener untuk orientasi perangkat
        window.addEventListener("deviceorientation", updateHeading);

        // Tambahkan POIs ke scene
        renderPOIs();
      }

      function startLocationTracking() {
        if ("geolocation" in navigator) {
          // Opsi pelacakan lokasi
          const options = {
            enableHighAccuracy: true, // Akurasi tinggi
            maximumAge: 0, // Tidak menggunakan cache
            timeout: 27000, // Timeout dalam ms
          };

          // Mulai pelacakan lokasi secara terus-menerus
          watchId = navigator.geolocation.watchPosition(updateUserLocation, locationError, options);
        } else {
          alert("Geolocation tidak didukung oleh browser Anda");
        }
      }

      function updateUserLocation(position) {
        userLocation = {
          lat: position.coords.latitude,
          lon: position.coords.longitude,
          alt: position.coords.altitude || 0,
          accuracy: position.coords.accuracy,
        };

        // Update display
        document.getElementById("location-display").innerHTML = `
                lat: ${userLocation.lat.toFixed(7)} <br>
                lon: ${userLocation.lon.toFixed(7)} <br>
                altitude: ${userLocation.alt.toFixed(2)} m
            `;

        // Update jarak ke POIs
        updateDistancesToPOIs();
      }

      function locationError(error) {
        console.error("Error mendapatkan lokasi:", error);
        alert(`Kesalahan lokasi: ${error.message}`);
      }

      function updateHeading(event) {
        // Mendapatkan heading dari event deviceorientation
        if (event.webkitCompassHeading) {
          // Untuk iOS
          userHeading = event.webkitCompassHeading;
        } else if (event.alpha) {
          // Untuk Android
          userHeading = 360 - event.alpha;
        }

        // Update display
        document.getElementById("bearing-display").innerHTML = `Bearing: ${userHeading.toFixed(2)}Â°`;
      }

      function renderPOIs() {
        const placesContainer = document.getElementById("places-container");

        POIs.forEach((poi, index) => {
          // Buat entity untuk POI
          const poiEntity = document.createElement("a-entity");
          poiEntity.setAttribute("id", `poi-${index}`);
          poiEntity.setAttribute("gps-entity-place", `latitude: ${poi.lat}; longitude: ${poi.lon}`);
          poiEntity.setAttribute("look-at", "[gps-camera]");
          poiEntity.setAttribute("scale", "20 20 20"); // Ukuran yang lebih besar agar terlihat dari jauh

          // Buat objek visual untuk POI (lingkaran 3D)
          const circle = document.createElement("a-circle");
          circle.setAttribute("color", "white");
          circle.setAttribute("radius", "0.5");
          circle.setAttribute("material", "opacity: 0.8");

          // Buat label teks untuk POI
          const text = document.createElement("a-text");
          text.setAttribute("value", poi.name);
          text.setAttribute("color", "white");
          text.setAttribute("align", "center");
          text.setAttribute("position", "0 0.75 0");
          text.setAttribute("scale", "2 2 2");

          // Tambahkan objek visual dan teks ke entity POI
          poiEntity.appendChild(circle);
          poiEntity.appendChild(text);

          // Tambahkan POI ke container
          placesContainer.appendChild(poiEntity);

          // Set event listener untuk scaling berdasarkan jarak
          poiEntity.addEventListener("gps-entity-place-update-position", (event) => {
            // Jarak dalam meter
            const distance = event.detail.distance;

            // Skala berdasarkan jarak (semakin dekat semakin besar)
            // Rumus: baseScale * (1 + (maxDist - distance) / maxDist)
            const baseScale = 15;
            const maxDist = 5000; // maksimum jarak dalam meter
            const scaleFactor = Math.max(0.5, Math.min(3, 1 + (maxDist - distance) / maxDist));

            // Terapkan skala baru
            poiEntity.setAttribute("scale", `${baseScale * scaleFactor} ${baseScale * scaleFactor} ${baseScale * scaleFactor}`);
          });
        });
      }

      function updateDistancesToPOIs() {
        if (!userLocation) return;

        const distanceContainer = document.getElementById("distance-indicators");
        distanceContainer.innerHTML = ""; // Bersihkan indikator jarak sebelumnya

        POIs.forEach((poi, index) => {
          // Hitung jarak menggunakan Turf.js
          const from = turf.point([userLocation.lon, userLocation.lat]);
          const to = turf.point([poi.lon, poi.lat]);
          const distance = turf.distance(from, to, { units: "kilometers" }) * 1000; // konversi ke meter

          // Hitung bearing ke POI
          const bearing = turf.bearing(from, to);

          // Buat element untuk indikator jarak
          const indicator = document.createElement("div");
          indicator.className = "fixed flex flex-col items-center transform -translate-x-1/2";
          indicator.style.bottom = "80px";
          indicator.style.left = `${50 + (bearing - userHeading) * 0.5}%`; // Posisi horizontal berdasarkan bearing relatif

          // Format jarak untuk display
          let distanceText = "";
          if (distance < 1000) {
            distanceText = `${Math.round(distance)} m`;
          } else {
            distanceText = `${(distance / 1000).toFixed(2)} km`;
          }

          // Tambahkan konten ke indikator
          indicator.innerHTML = `
                    <div class="text-xs font-bold bg-black text-white px-2 py-1 rounded">
                        ${poi.name}: ${distanceText}
                    </div>
                    <div class="h-16 w-0.5 bg-white"></div>
                `;

          // Tambahkan indikator ke container
          distanceContainer.appendChild(indicator);
        });
      }

      // Fungsi untuk menambahkan POI baru
      function addNewPOI(name, lat, lon, altitude = 0) {
        // Tambahkan ke array POIs
        POIs.push({ name, lat, lon, altitude });

        // Render ulang POIs
        document.getElementById("places-container").innerHTML = "";
        renderPOIs();
      }

      // Pembersihan ketika aplikasi ditutup
      window.onbeforeunload = () => {
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
        }
      };
    </script>
  </body>
</html>
