<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Aplikasi AR Berbasis Lokasi</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- A-Frame dan AR.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>

    <style>
      .ar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
      }

      .location-info {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        padding: 1rem;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        z-index: 20;
      }

      /* Tambahkan style untuk tombol izin kamera */
      #camera-permission {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 1rem 2rem;
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-size: 1.2rem;
        cursor: pointer;
        z-index: 30;
      }

      /* Status loading */
      #loading-indicator {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        z-index: 25;
      }
    </style>
  </head>
  <body class="m-0 p-0 overflow-hidden">
    <!-- Tombol untuk meminta izin kamera -->
    <button id="camera-permission" class="shadow-lg">Aktifkan Kamera AR</button>

    <!-- Loading indicator -->
    <div id="loading-indicator" class="hidden">Memuat AR dan lokasi...</div>

    <!-- A-Frame Scene (akan ditampilkan setelah izin) -->
    <a-scene
      id="ar-scene"
      embedded
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; sourceWidth: 1280; sourceHeight: 960; displayWidth: 1280; displayHeight: 960;"
      renderer="logarithmicDepthBuffer: true; precision: medium;"
      style="display: none"
    >
      <!-- Kamera dengan atribut GPS -->
      <a-camera gps-projected-camera="gpsMinDistance: 5; gpsTimeInterval: 1000" rotation-reader look-controls-enabled="false" arjs-look-controls="smoothingFactor: 0.1" id="camera">
        <a-entity cursor="fuse: false; rayOrigin: mouse;" raycaster="far: 20; interval: 1000; objects: .clickable"></a-entity>
      </a-camera>

      <!-- Template untuk POI (Point of Interest) -->
      <a-entity id="places-container"></a-entity>
    </a-scene>

    <!-- UI Overlay -->
    <div class="location-info bg-blue-900 bg-opacity-70 text-white p-4" style="display: none">
      <div id="location-display" class="text-sm">Mencari lokasi...</div>
      <div id="bearing-display" class="text-sm">Menghitung arah...</div>
    </div>

    <!-- Indikator Jarak -->
    <div id="distance-indicators" class="ar-overlay"></div>

    <script>
      // Data POI (Points of Interest)
      const POIs = [
        { name: "Rumah Irfan", lat: -6.9867784, lon: 107.6457581, altitude: 684.3 },
        { name: "Linh Ung Pagoda", lat: 16.1072989, lon: 108.2343984, altitude: 0 },
      ];

      // Variabel untuk lokasi pengguna
      let userLocation = null;
      let userHeading = 0;
      let watchId = null;
      let cameraStarted = false;

      // Inisialisasi aplikasi
      window.onload = () => {
        document.getElementById("camera-permission").addEventListener("click", initializeApp);
      };

      function initializeApp() {
        // Tampilkan indikator loading
        document.getElementById("loading-indicator").classList.remove("hidden");

        // Sembunyikan tombol izin
        document.getElementById("camera-permission").style.display = "none";

        // Mulai dengan meminta izin kamera secara eksplisit
        navigator.mediaDevices
          .getUserMedia({ video: { facingMode: "environment" } })
          .then((stream) => {
            console.log("Izin kamera diberikan");

            // Tampilkan scene AR
            document.getElementById("ar-scene").style.display = "block";
            document.querySelector(".location-info").style.display = "block";

            // Mulai pelacakan lokasi
            startLocationTracking();

            // Tambahkan event listener untuk orientasi perangkat
            window.addEventListener("deviceorientation", handleDeviceOrientation, true);

            // Tambahkan POIs ke scene
            renderPOIs();

            // Sembunyikan loading indicator setelah beberapa detik
            setTimeout(() => {
              document.getElementById("loading-indicator").classList.add("hidden");
            }, 3000);
          })
          .catch((error) => {
            console.error("Gagal mendapatkan izin kamera:", error);
            alert("Izin kamera diperlukan untuk AR. Error: " + error.message);
            document.getElementById("camera-permission").style.display = "block";
            document.getElementById("loading-indicator").classList.add("hidden");
          });
      }

      function handleDeviceOrientation(event) {
        // Cek apakah perlu izin untuk iOS 13+
        if (typeof DeviceOrientationEvent.requestPermission === "function") {
          // iOS 13+ membutuhkan izin eksplisit
          DeviceOrientationEvent.requestPermission()
            .then((permissionState) => {
              if (permissionState === "granted") {
                window.addEventListener("deviceorientation", updateHeading);
              } else {
                alert("Izin orientasi perangkat diperlukan untuk mengetahui arah pengguna");
              }
            })
            .catch(console.error);

          // Hapus event listener ini karena sudah tidak diperlukan
          window.removeEventListener("deviceorientation", handleDeviceOrientation, true);
        } else {
          // Perangkat lain langsung menggunakan event handler
          window.removeEventListener("deviceorientation", handleDeviceOrientation, true);
          window.addEventListener("deviceorientation", updateHeading);
        }
      }

      function startLocationTracking() {
        if ("geolocation" in navigator) {
          // Opsi pelacakan lokasi
          const options = {
            enableHighAccuracy: true, // Akurasi tinggi
            maximumAge: 0, // Tidak menggunakan cache
            timeout: 27000, // Timeout dalam ms
          };

          // Mulai pelacakan lokasi secara terus-menerus
          watchId = navigator.geolocation.watchPosition(updateUserLocation, locationError, options);
        } else {
          alert("Geolocation tidak didukung oleh browser Anda");
        }
      }

      function updateUserLocation(position) {
        userLocation = {
          lat: position.coords.latitude,
          lon: position.coords.longitude,
          alt: position.coords.altitude || 0,
          accuracy: position.coords.accuracy,
        };

        // Update display
        document.getElementById("location-display").innerHTML = `
                lat: ${userLocation.lat.toFixed(7)} <br>
                lon: ${userLocation.lon.toFixed(7)} <br>
                altitude: ${userLocation.alt.toFixed(2)} m
            `;

        // Update jarak ke POIs
        updateDistancesToPOIs();
      }

      function locationError(error) {
        console.error("Error mendapatkan lokasi:", error);
        alert(`Kesalahan lokasi: ${error.message}`);
      }

      function updateHeading(event) {
        // Mendapatkan heading dari event deviceorientation
        if (event.webkitCompassHeading) {
          // Untuk iOS
          userHeading = event.webkitCompassHeading;
        } else if (event.alpha) {
          // Untuk Android
          userHeading = 360 - event.alpha;
        }

        // Update display
        document.getElementById("bearing-display").innerHTML = `Bearing: ${userHeading.toFixed(2)}Â°`;
      }

      function renderPOIs() {
        const placesContainer = document.getElementById("places-container");

        POIs.forEach((poi, index) => {
          // Buat entity untuk POI
          const poiEntity = document.createElement("a-entity");
          poiEntity.setAttribute("id", `poi-${index}`);
          poiEntity.setAttribute("gps-entity-place", `latitude: ${poi.lat}; longitude: ${poi.lon}`);
          poiEntity.setAttribute("look-at", "[gps-projected-camera]");
          poiEntity.setAttribute("scale", "20 20 20"); // Ukuran yang lebih besar agar terlihat dari jauh
          poiEntity.setAttribute("class", "clickable");

          // Buat objek visual untuk POI (lingkaran 3D)
          const circle = document.createElement("a-circle");
          circle.setAttribute("color", "#4285F4");
          circle.setAttribute("radius", "0.5");
          circle.setAttribute("material", "opacity: 0.8");

          // Buat label teks untuk POI
          const text = document.createElement("a-text");
          text.setAttribute("value", poi.name);
          text.setAttribute("color", "white");
          text.setAttribute("align", "center");
          text.setAttribute("position", "0 0.75 0");
          text.setAttribute("scale", "2 2 2");
          text.setAttribute("side", "double");

          // Tambahkan objek visual dan teks ke entity POI
          poiEntity.appendChild(circle);
          poiEntity.appendChild(text);

          // Tambahkan POI ke container
          placesContainer.appendChild(poiEntity);

          // Set event listener untuk scaling berdasarkan jarak
          poiEntity.addEventListener("gps-entity-place-update-position", (event) => {
            // Jarak dalam meter
            const distance = event.detail.distance;

            // Skala berdasarkan jarak (semakin dekat semakin besar)
            // Rumus: baseScale * (1 + (maxDist - distance) / maxDist)
            const baseScale = 15;
            const maxDist = 5000; // maksimum jarak dalam meter
            const scaleFactor = Math.max(0.5, Math.min(3, 1 + (maxDist - distance) / maxDist));

            // Tampilkan jarak di konsol untuk debugging
            console.log(`Jarak ke ${poi.name}: ${distance.toFixed(2)} m`);

            // Terapkan skala baru
            poiEntity.setAttribute("scale", `${baseScale * scaleFactor} ${baseScale * scaleFactor} ${baseScale * scaleFactor}`);
          });

          // Tambahkan event listener untuk klik pada POI
          poiEntity.addEventListener("click", () => {
            alert(`Anda mengklik ${poi.name}`);
          });
        });
      }

      function updateDistancesToPOIs() {
        if (!userLocation) return;

        const distanceContainer = document.getElementById("distance-indicators");
        distanceContainer.innerHTML = ""; // Bersihkan indikator jarak sebelumnya

        POIs.forEach((poi, index) => {
          // Hitung jarak menggunakan Turf.js
          const from = turf.point([userLocation.lon, userLocation.lat]);
          const to = turf.point([poi.lon, poi.lat]);
          const distance = turf.distance(from, to, { units: "kilometers" }) * 1000; // konversi ke meter

          // Hitung bearing ke POI
          const bearing = turf.bearing(from, to);

          // Buat element untuk indikator jarak
          const indicator = document.createElement("div");
          indicator.className = "fixed flex flex-col items-center transform -translate-x-1/2";
          indicator.style.bottom = "80px";
          indicator.style.left = `${50 + (bearing - userHeading) * 0.5}%`; // Posisi horizontal berdasarkan bearing relatif

          // Format jarak untuk display
          let distanceText = "";
          if (distance < 1000) {
            distanceText = `${Math.round(distance)} m`;
          } else {
            distanceText = `${(distance / 1000).toFixed(2)} km`;
          }

          // Tambahkan konten ke indikator
          indicator.innerHTML = `
                    <div class="text-xs font-bold bg-black text-white px-2 py-1 rounded">
                        ${poi.name}: ${distanceText}
                    </div>
                    <div class="h-16 w-0.5 bg-white"></div>
                `;

          // Tambahkan indikator ke container
          distanceContainer.appendChild(indicator);
        });
      }

      // Fungsi untuk menambahkan POI baru
      function addNewPOI(name, lat, lon, altitude = 0) {
        // Tambahkan ke array POIs
        POIs.push({ name, lat, lon, altitude });

        // Render ulang POIs
        document.getElementById("places-container").innerHTML = "";
        renderPOIs();
      }

      // Dapatkan lokasi saat ini dan tambahkan sebagai POI
      function addCurrentLocationAsPOI() {
        if (userLocation) {
          const name = prompt("Masukkan nama untuk lokasi ini:", "Lokasi Saya");
          if (name) {
            addNewPOI(name, userLocation.lat, userLocation.lon, userLocation.alt);
          }
        } else {
          alert("Lokasi pengguna belum tersedia");
        }
      }

      // Pembersihan ketika aplikasi ditutup
      window.onbeforeunload = () => {
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
        }
      };
    </script>
  </body>
</html>
