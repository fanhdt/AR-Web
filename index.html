<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
    <title>AR Berbasis Lokasi</title>

    <!-- Import A-Frame terlebih dahulu -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- Import AR.js dengan dependensi yang benar -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        -webkit-user-select: none;
        user-select: none;
        background-color: transparent;
      }

      .arjs-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        font-family: Arial, sans-serif;
      }

      .info-panel {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        padding: 10px;
        background-color: rgba(25, 55, 125, 0.8);
        color: white;
        font-family: Arial, sans-serif;
        z-index: 10;
        font-size: 14px;
      }

      .distance-indicator {
        position: absolute;
        width: auto;
        height: auto;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        border-radius: 5px;
        padding: 5px;
        font-family: Arial, sans-serif;
        z-index: 5;
        pointer-events: none;
        transform: translate(-50%, -50%);
      }

      #permissionButton {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 25px;
        background-color: #4c51bf;
        color: white;
        border: none;
        border-radius: 5px;
        z-index: 999;
        font-weight: bold;
        font-size: 16px;
      }

      #debugInfo {
        position: fixed;
        bottom: 70px;
        left: 0;
        width: 100%;
        padding: 5px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        font-size: 12px;
        z-index: 8;
        text-align: center;
      }

      .a-canvas {
        width: 100% !important;
        height: 100% !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        z-index: 1 !important;
      }
    </style>
  </head>
  <body>
    <!-- Loader saat memuat -->
    <div class="arjs-loader">
      <div>Memuat aplikasi AR, mohon tunggu...</div>
    </div>

    <!-- Panel Informasi -->
    <div class="info-panel">
      <div id="locationInfo">Menunggu lokasi...</div>
      <div id="bearingInfo">Arah: --°</div>
    </div>

    <!-- Tombol izin kamera dan lokasi -->
    <button id="permissionButton">Mulai AR - Izinkan Kamera & Lokasi</button>

    <!-- Debug Info -->
    <div id="debugInfo">Status: Menunggu interaksi pengguna</div>

    <!-- A-Frame Scene - HIDDEN BY DEFAULT -->
    <div id="scene-container" style="display: none">
      <a-scene vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix;" renderer="logarithmicDepthBuffer: true; antialias: true" loading-screen="enabled: false">
        <!-- Kamera dengan rotation-reader untuk mendapatkan rotasi perangkat -->
        <a-entity camera look-controls></a-entity>
      </a-scene>
    </div>

    <script>
      // Daftar Points of Interest (koordinat dalam format latitude, longitude)
      const poisData = [
        { name: "Rumah Thanos", lat: -6.986781, lon: 107.6478585, alt: 684 },
        { name: "Gedung Basics tower 1", lat: -6.881909, lon: 107.611547, alt: 830 },
        { name: "Masjid BRIN", lat: -6.882004, lon: 107.6111434, alt: 830 },
        // POI dari gambar
        { name: "Sun Wheel", lat: 16.0404856, lon: 108.2262447, alt: 0 },
        { name: "Linh Ung Pagoda", lat: 16.1072989, lon: 108.2343984, alt: 0 },
      ];

      // Variabel untuk menyimpan referensi
      let currentPosition = null;
      let watchId = null;
      let compassHeading = 0;
      const pois = {};
      const distanceIndicators = {};
      let appInitialized = false;

      // Ambil referensi ke elemen-elemen
      const permissionButton = document.getElementById("permissionButton");
      const debugInfo = document.getElementById("debugInfo");
      const locationInfo = document.getElementById("locationInfo");
      const bearingInfo = document.getElementById("bearingInfo");
      const arjsLoader = document.querySelector(".arjs-loader");
      const sceneContainer = document.getElementById("scene-container");

      // Fungsi untuk memperbarui informasi debug
      function updateDebugInfo(message) {
        debugInfo.textContent = `Status: ${message}`;
        console.log(message);
      }

      // Fungsi untuk mengupdate tampilan lokasi pada panel info
      function updateLocationInfo(position) {
        if (!position || !position.coords) {
          locationInfo.innerHTML = "Lokasi tidak tersedia";
          return;
        }

        locationInfo.innerHTML = `
          lat: ${position.coords.latitude.toFixed(7)}<br>
          lon: ${position.coords.longitude.toFixed(7)}<br>
          altitude: ${position.coords.altitude ? position.coords.altitude.toFixed(2) : "N/A"}
        `;

        // Update jarak ke semua POIs
        updateDistances(position);
      }

      // Menghitung jarak antara dua titik koordinat menggunakan Haversine formula
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // radius Bumi dalam meter
        const φ1 = (lat1 * Math.PI) / 180;
        const φ2 = (lat2 * Math.PI) / 180;
        const Δφ = ((lat2 - lat1) * Math.PI) / 180;
        const Δλ = ((lon2 - lon1) * Math.PI) / 180;

        const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c; // jarak dalam meter
      }

      // Menghitung bearing antara dua titik koordinat
      function calculateBearing(lat1, lon1, lat2, lon2) {
        lat1 = (lat1 * Math.PI) / 180;
        lon1 = (lon1 * Math.PI) / 180;
        lat2 = (lat2 * Math.PI) / 180;
        lon2 = (lon2 * Math.PI) / 180;

        const y = Math.sin(lon2 - lon1) * Math.cos(lat2);
        const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);
        const bearing = Math.atan2(y, x);

        return ((bearing * 180) / Math.PI + 360) % 360; // dalam derajat
      }

      // Fungsi untuk mengupdate jarak ke semua POIs
      function updateDistances(position) {
        poisData.forEach((poi) => {
          const distance = calculateDistance(position.coords.latitude, position.coords.longitude, poi.lat, poi.lon);
          const bearing = calculateBearing(position.coords.latitude, position.coords.longitude, poi.lat, poi.lon);

          // Update indikator jarak jika sudah ada
          if (distanceIndicators[poi.name]) {
            distanceIndicators[poi.name].textContent = `${poi.name}: ${distance.toFixed(0)}m, Bearing: ${bearing.toFixed(0)}°`;
          }

          // Update ukuran dan posisi entitas berdasarkan jarak
          if (pois[poi.name]) {
            // Semakin dekat semakin besar, dengan batas minimum dan maksimum
            const scale = Math.min(Math.max(20 / (distance / 100), 0.5), 5);
            pois[poi.name].setAttribute("scale", `${scale} ${scale} ${scale}`);

            // Update posisi berdasarkan rotasi kompas
            updatePoiPosition(poi, distance, bearing);
          }
        });
      }

      // Fungsi untuk mengupdate posisi POI berdasarkan kompas
      function updatePoiPosition(poi, distance, bearing) {
        if (!pois[poi.name]) return;

        // Konversi bearing ke radians
        const bearingRad = (bearing * Math.PI) / 180;

        // Hitung posisi relatif terhadap pengguna (dalam koordinat scene A-Frame)
        // Faktor skala untuk mengonversi meter ke unit A-Frame
        const scale = 0.1;
        const scaledDistance = distance * scale;

        // Hitung posisi X (timur/barat) dan Z (utara/selatan) berdasarkan bearing
        const x = Math.sin(bearingRad) * scaledDistance;
        const z = -Math.cos(bearingRad) * scaledDistance;

        // Hitung elevasi (y) berdasarkan perbedaan ketinggian
        let y = 0;
        if (currentPosition && currentPosition.coords.altitude && poi.alt) {
          y = (poi.alt - currentPosition.coords.altitude) * scale;
        }

        // Set posisi entity
        pois[poi.name].setAttribute("position", `${x} ${y} ${z}`);

        // Pastikan entitas selalu menghadap kamera
        pois[poi.name].setAttribute("look-at", "[camera]");
      }

      // Fungsi untuk mengatur POIs dan indikator jarak
      function setupPOIs() {
        updateDebugInfo("Menyiapkan Points of Interest");
        const scene = document.querySelector("a-scene");

        poisData.forEach((poi) => {
          // Buat entity untuk POI
          const entity = document.createElement("a-entity");
          entity.setAttribute("id", `poi-${poi.name.replace(/\s+/g, "-").toLowerCase()}`);

          // Tambahkan lingkaran sebagai marker dengan material emissive untuk terlihat jelas
          const circle = document.createElement("a-circle");
          circle.setAttribute("radius", "1.5");
          circle.setAttribute("color", "#00BFFF");
          circle.setAttribute("opacity", "0.8");
          circle.setAttribute("material", "emissive: #00BFFF; emissiveIntensity: 0.5");
          entity.appendChild(circle);

          // Tambahkan teks nama POI
          const text = document.createElement("a-text");
          text.setAttribute("value", poi.name);
          text.setAttribute("align", "center");
          text.setAttribute("position", "0 2 0");
          text.setAttribute("scale", "2 2 2");
          text.setAttribute("color", "white");
          text.setAttribute("side", "double");
          text.setAttribute("wrap-count", "15");
          entity.appendChild(text);

          // Tambahkan entity ke scene
          scene.appendChild(entity);
          pois[poi.name] = entity;

          updateDebugInfo(`POI ditambahkan: ${poi.name}`);

          // Buat indikator jarak untuk POI ini
          const distanceIndicator = document.createElement("div");
          distanceIndicator.className = "distance-indicator";
          distanceIndicator.textContent = `${poi.name}: --m`;
          document.body.appendChild(distanceIndicator);
          distanceIndicators[poi.name] = distanceIndicator;
        });
      }

      // Mendapatkan arah kompas (bearing)
      function handleOrientation(event) {
        if (event.webkitCompassHeading) {
          // Untuk iOS
          compassHeading = event.webkitCompassHeading;
        } else if (event.alpha) {
          // Untuk Android
          compassHeading = 360 - event.alpha; // Konversi ke format kompas standar
        }

        // Update tampilan arah
        bearingInfo.textContent = `Arah: ${Math.round(compassHeading)}°`;

        // Update posisi POI secara real-time berdasarkan orientasi
        if (currentPosition) {
          poisData.forEach((poi) => {
            const distance = calculateDistance(currentPosition.coords.latitude, currentPosition.coords.longitude, poi.lat, poi.lon);
            const bearing = calculateBearing(currentPosition.coords.latitude, currentPosition.coords.longitude, poi.lat, poi.lon);
            updatePoiPosition(poi, distance, bearing);
          });
        }
      }

      // Inisialisasi A-Frame scene dan menampilkan kamera
      function initializeARScene() {
        updateDebugInfo("Menginisialisasi scene AR");

        // Tampilkan kontainer scene
        sceneContainer.style.display = "block";

        // Tunggu sebentar untuk memastikan A-Frame scene dirender dengan benar
        setTimeout(() => {
          const scene = document.querySelector("a-scene");
          if (scene) {
            updateDebugInfo("Scene AR berhasil diinisialisasi");

            // Cek apakah canvas sudah dibuat
            const canvas = document.querySelector(".a-canvas");
            if (canvas) {
              // Pastikan canvas mengisi seluruh layar
              canvas.style.width = "100vw";
              canvas.style.height = "100vh";
              canvas.style.position = "fixed";
              canvas.style.top = "0";
              canvas.style.left = "0";
              canvas.style.zIndex = "1";
              updateDebugInfo("Canvas AR berhasil disesuaikan untuk memenuhi layar");
            } else {
              updateDebugInfo("PERINGATAN: Canvas AR tidak ditemukan");
            }
          } else {
            updateDebugInfo("PERINGATAN: Scene AR tidak ditemukan");
          }
        }, 1000);
      }

      // Mulai geolokasi dan layanan lainnya
      function startARExperience() {
        updateDebugInfo("Memulai pengalaman AR");

        // Pastikan loader tersembunyi
        arjsLoader.style.display = "none";

        // Sembunyikan tombol izin
        permissionButton.style.display = "none";

        // Inisialisasi A-Frame scene dan tampilkan kamera
        initializeARScene();

        // Minta lokasi pengguna
        startGeolocation();

        // Register untuk device orientation
        startOrientationTracking();

        appInitialized = true;
      }

      // Fungsi untuk memulai geolokasi
      function startGeolocation() {
        updateDebugInfo("Meminta izin geolokasi");

        if (!navigator.geolocation) {
          updateDebugInfo("Geolocation tidak didukung pada browser ini");
          return;
        }

        // Opsi untuk geolokasi dengan presisi tinggi
        const options = {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 27000,
        };

        try {
          // Meminta posisi saat ini
          navigator.geolocation.getCurrentPosition(
            (position) => {
              updateDebugInfo("Posisi GPS diterima");
              currentPosition = position;
              updateLocationInfo(position);

              // Setup POIs setelah mendapatkan lokasi
              setupPOIs();

              // Memulai pengawasan posisi berkelanjutan
              watchId = navigator.geolocation.watchPosition(
                (newPosition) => {
                  currentPosition = newPosition;
                  updateLocationInfo(newPosition);
                },
                (error) => {
                  updateDebugInfo(`Error pemantauan lokasi: ${error.message}`);
                },
                options
              );
            },
            (error) => {
              updateDebugInfo(`Geolocation error: ${error.code} - ${error.message}`);
              alert(`Gagal mendapatkan lokasi: ${error.message}`);
            },
            options
          );
        } catch (e) {
          updateDebugInfo(`Exception dalam geolocation: ${e.message}`);
        }
      }

      // Memulai tracking orientasi perangkat
      function startOrientationTracking() {
        updateDebugInfo("Memulai tracking orientasi");

        if (window.DeviceOrientationEvent) {
          if (typeof DeviceOrientationEvent.requestPermission === "function") {
            // iOS 13+ memerlukan izin eksplisit
            DeviceOrientationEvent.requestPermission()
              .then((permissionState) => {
                if (permissionState === "granted") {
                  window.addEventListener("deviceorientation", handleOrientation, true);
                  updateDebugInfo("Izin orientasi diberikan");
                } else {
                  updateDebugInfo("Izin orientasi ditolak");
                }
              })
              .catch((error) => {
                updateDebugInfo(`Error izin orientasi: ${error.message}`);
                // Coba tambahkan event listener meskipun ada error
                window.addEventListener("deviceorientation", handleOrientation, true);
              });
          } else {
            // Handle regular non-iOS 13+ devices
            window.addEventListener("deviceorientation", handleOrientation, true);
            updateDebugInfo("Orientasi didaftarkan tanpa izin khusus");
          }
        } else {
          updateDebugInfo("DeviceOrientation tidak didukung perangkat ini");
        }
      }

      // Update posisi indikator jarak dalam tampilan
      function updateDistanceIndicatorPositions() {
        if (!currentPosition) return;

        Object.keys(distanceIndicators).forEach((poiName) => {
          const poi = poisData.find((p) => p.name === poiName);
          if (!poi || !pois[poiName]) return;

          // Dapatkan posisi 3D dari entitas dalam scene
          const entity = pois[poiName];

          // Posisikan indikator jarak di dekat label POI
          const indicator = distanceIndicators[poiName];
          const distance = calculateDistance(currentPosition.coords.latitude, currentPosition.coords.longitude, poi.lat, poi.lon);

          // Sesuaikan posisi indikator jarak pada layar
          indicator.style.top = `${window.innerHeight * 0.3 + Object.keys(distanceIndicators).indexOf(poiName) * 40}px`;
          indicator.style.left = `${window.innerWidth / 2}px`;
        });
      }

      // Inisialisasi saat dokumen dimuat
      document.addEventListener("DOMContentLoaded", function () {
        updateDebugInfo("DOM loaded, menunggu interaksi user");

        // Set event listener untuk tombol izin
        permissionButton.addEventListener("click", function () {
          updateDebugInfo("Tombol izin diklik");

          // Untuk perangkat iOS, minta izin kamera terlebih dahulu
          if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices
              .getUserMedia({ video: { facingMode: "environment" } })
              .then(function (stream) {
                updateDebugInfo("Izin kamera diberikan");
                // Lanjut ke memulai AR
                startARExperience();
              })
              .catch(function (error) {
                updateDebugInfo(`Error izin kamera: ${error.message}`);
                alert(`Izin kamera ditolak: ${error.message}`);
              });
          } else {
            updateDebugInfo("getUserMedia tidak didukung");
            startARExperience(); // Coba memulai AR tanpa izin kamera eksplisit
          }
        });

        // Update posisi indikator jarak secara berkala
        setInterval(updateDistanceIndicatorPositions, 1000);
      });

      // Handling untuk fullscreen
      document.addEventListener("dblclick", () => {
        const sceneEl = document.querySelector("a-scene");
        if (!sceneEl) return;

        if (document.fullscreenElement) {
          // Jika sudah fullscreen, tidak perlu melakukan apa-apa
          return;
        }

        if (sceneEl.requestFullscreen) {
          sceneEl.requestFullscreen();
        } else if (sceneEl.mozRequestFullScreen) {
          sceneEl.mozRequestFullScreen();
        } else if (sceneEl.webkitRequestFullscreen) {
          sceneEl.webkitRequestFullscreen();
        } else if (sceneEl.msRequestFullscreen) {
          sceneEl.msRequestFullscreen();
        }
      });

      // Deteksi rotasi layar
      window.addEventListener("orientationchange", function () {
        setTimeout(() => {
          const canvas = document.querySelector(".a-canvas");
          if (canvas) {
            canvas.style.width = "100vw";
            canvas.style.height = "100vh";
          }
          updateDistanceIndicatorPositions();
        }, 200);
      });

      // Tambahan: Resize event untuk memastikan layar selalu terisi penuh
      window.addEventListener("resize", function () {
        const canvas = document.querySelector(".a-canvas");
        if (canvas) {
          canvas.style.width = "100vw";
          canvas.style.height = "100vh";
        }
        updateDistanceIndicatorPositions();
      });
    </script>
  </body>
</html>
