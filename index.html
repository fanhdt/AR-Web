<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Enhanced AR Location App</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        overflow: hidden;
        margin: 0;
        padding: 0;
      }

      #ui-container {
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      }

      .distance-indicator {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border-radius: 4px;
        padding: 2px 8px;
        font-size: 12px;
        position: absolute;
        transform: translate(-50%, -50%);
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div id="ui-container" class="absolute top-0 left-0 w-full p-4 z-10 text-white bg-blue-900 bg-opacity-70">
      <h1 class="text-lg font-bold">Enhanced AR Location App</h1>
      <div id="location-info" class="text-sm">
        <p id="current-lat">lat: Mencari...</p>
        <p id="current-lon">lon: Mencari...</p>
        <p id="current-alt">altitude: Mencari...</p>
      </div>
      <div id="bearing-info" class="text-sm">
        <p id="bearing">Bearing: Mencari...</p>
        <p id="nearest-poi">Lokasi Terdekat: -</p>
      </div>
    </div>

    <!-- Scene AR.js dengan pengaturan yang ditingkatkan -->
    <a-scene
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false; 
            sourceWidth: window.innerWidth; sourceHeight: window.innerHeight;
            trackingMethod: best; maxDetectionRate: 60;"
    >
      <!-- Kamera dengan pengaturan GPS yang diperbaiki -->
      <a-camera gps-projected-camera="gpsMinDistance: 1; gpsTimeInterval: 100" rotation-reader look-controls-enabled="false"></a-camera>

      <!-- Aset dan model -->
      <a-assets>
        <a-asset-item id="arrow-obj" src="https://cdn.glitch.global/f8a66d7c-a9be-4c5c-96f6-104070e76271/arrow.obj?v=1618590849906"></a-asset-item>
      </a-assets>

      <!-- Container untuk POI yang akan ditambahkan secara dinamis -->
      <a-entity id="poi-container"></a-entity>
    </a-scene>

    <!-- Container untuk elemen jarak -->
    <div id="distance-indicators"></div>

    <script>
      // Kode untuk points of interest
      const POINTS_OF_INTEREST = [
        {
          name: "Rumah Irfan",
          latitude: -6.986781,
          longitude: 107.647585,
          altitude: 684,
          color: "#FF5733",
        },
        {
          name: "Linh Ung Pagoda",
          latitude: 16.1072989,
          longitude: 108.2343984,
          altitude: 0,
          color: "#3366FF",
        },
      ];

      // Konfigurasi tampilan
      const CONFIG = {
        minScale: 0.5, // Skala minimum objek
        maxScale: 5, // Skala maksimum objek
        minDistance: 5, // Jarak minimum untuk skala maksimum (dalam meter)
        maxDistance: 10000, // Jarak maksimum untuk skala minimum (dalam meter)
        visibleDistance: 10000, // Jarak maksimum objek terlihat (meter)
        pathUpdateInterval: 200, // Interval pembaruan path (ms)
      };

      // Fungsi untuk menghitung jarak antara dua titik geografis
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Radius bumi dalam meter
        const φ1 = toRadians(lat1);
        const φ2 = toRadians(lat2);
        const Δφ = toRadians(lat2 - lat1);
        const Δλ = toRadians(lon2 - lon1);

        const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Fungsi untuk menghitung bearing/arah antara dua titik geografis
      function calculateBearing(lat1, lon1, lat2, lon2) {
        const φ1 = toRadians(lat1);
        const φ2 = toRadians(lat2);
        const Δλ = toRadians(lon2 - lon1);

        const y = Math.sin(Δλ) * Math.cos(φ2);
        const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);

        let bearing = (Math.atan2(y, x) * 180) / Math.PI;
        bearing = (bearing + 360) % 360; // Konversi ke 0-360 derajat

        return bearing;
      }

      function toRadians(degrees) {
        return (degrees * Math.PI) / 180;
      }

      function toDegrees(radians) {
        return (radians * 180) / Math.PI;
      }

      // Elemen UI
      const latElement = document.getElementById("current-lat");
      const lonElement = document.getElementById("current-lon");
      const altElement = document.getElementById("current-alt");
      const bearingElement = document.getElementById("bearing");
      const nearestPoiElement = document.getElementById("nearest-poi");
      const distanceIndicatorsContainer = document.getElementById("distance-indicators");

      // Status aplikasi
      let userPosition = { latitude: 0, longitude: 0, altitude: 0 };
      let deviceHeading = 0;
      let poiEntities = {};
      let pathEntities = {};
      let distanceIndicators = {};
      let lastUpdateTime = 0;

      // Meminta izin lokasi dan memulai pelacakan
      function initLocationTracking() {
        if (navigator.geolocation) {
          navigator.geolocation.watchPosition(updatePosition, handleLocationError, {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 27000,
          });
        } else {
          alert("Geolocation tidak didukung oleh browser ini.");
        }
      }

      // Memperbarui posisi dan POI
      function updatePosition(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        const altitude = position.coords.altitude || 0;

        // Simpan posisi pengguna
        userPosition = { latitude, longitude, altitude };

        // Update UI dengan informasi lokasi
        latElement.textContent = `lat: ${latitude.toFixed(7)}`;
        lonElement.textContent = `lon: ${longitude.toFixed(7)}`;
        altElement.textContent = `altitude: ${altitude.toFixed(2)}`;

        // Update POI pada scene
        updatePOIEntities();

        // Tentukan POI terdekat
        updateNearestPOI();
      }

      // Menangani kesalahan lokasi
      function handleLocationError(error) {
        console.error("Error getting location:", error);
        alert(`Tidak dapat mengakses lokasi: ${error.message}`);
      }

      // Memperbarui informasi POI terdekat
      function updateNearestPOI() {
        let nearestPOI = null;
        let nearestDistance = Infinity;

        POINTS_OF_INTEREST.forEach((poi) => {
          const distance = calculateDistance(userPosition.latitude, userPosition.longitude, poi.latitude, poi.longitude);

          if (distance < nearestDistance) {
            nearestDistance = distance;
            nearestPOI = poi;
          }
        });

        if (nearestPOI) {
          nearestPoiElement.textContent = `Lokasi Terdekat: ${nearestPOI.name} (${formatDistance(nearestDistance)})`;
        } else {
          nearestPoiElement.textContent = "Lokasi Terdekat: -";
        }
      }

      // Menambahkan atau memperbarui POI pada scene
      function updatePOIEntities() {
        const currentTime = Date.now();
        const shouldUpdatePaths = currentTime - lastUpdateTime > CONFIG.pathUpdateInterval;

        if (shouldUpdatePaths) {
          lastUpdateTime = currentTime;
        }

        const scene = document.querySelector("a-scene");
        const container = document.getElementById("poi-container");

        // Kelola POI
        POINTS_OF_INTEREST.forEach((poi) => {
          const id = `poi-${poi.name.replace(/\\s+/g, "-").toLowerCase()}`;

          // Hitung jarak ke POI
          const distance = calculateDistance(userPosition.latitude, userPosition.longitude, poi.latitude, poi.longitude);

          // Hitung bearing ke POI
          const bearing = calculateBearing(userPosition.latitude, userPosition.longitude, poi.latitude, poi.longitude);

          // Jika terlalu jauh, sembunyikan - tetapi tetap buat dan tampilkan
          const isVisible = distance <= CONFIG.visibleDistance;

          // Buat atau perbarui entitas
          if (!poiEntities[id]) {
            // Buat entitas baru
            const entity = document.createElement("a-entity");
            entity.id = id;
            entity.setAttribute("data-distance", distance);
            entity.setAttribute("data-poi-name", poi.name);

            // Marker utama (lingkaran dengan skala yang adaptif)
            const marker = document.createElement("a-entity");
            marker.id = `${id}-marker`;

            // Lingkaran sebagai marker
            const circle = document.createElement("a-circle");
            circle.setAttribute("color", poi.color || "#FFFFFF");
            circle.setAttribute("radius", "0.5");
            circle.setAttribute("opacity", "0.9");
            circle.setAttribute("material", "side: double");
            circle.setAttribute("animation", "property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear");
            marker.appendChild(circle);

            // Lingkaran luar untuk efek pulsa
            const outerCircle = document.createElement("a-circle");
            outerCircle.setAttribute("color", poi.color || "#FFFFFF");
            outerCircle.setAttribute("radius", "0.7");
            outerCircle.setAttribute("opacity", "0.4");
            outerCircle.setAttribute("material", "side: double");
            outerCircle.setAttribute("animation", "property: scale; from: 0.8 0.8 0.8; to: 1.5 1.5 1.5; loop: true; dur: 2000; dir: alternate");
            marker.appendChild(outerCircle);

            // Tambahkan teks nama lokasi
            const text = document.createElement("a-text");
            text.setAttribute("value", poi.name);
            text.setAttribute("color", "white");
            text.setAttribute("align", "center");
            text.setAttribute("position", "0 1.2 0");
            text.setAttribute("scale", "1 1 1");
            text.setAttribute("side", "double");
            text.setAttribute("font", "https://cdn.aframe.io/fonts/DejaVu-sdf.fnt");
            marker.appendChild(text);

            // Tambahkan teks jarak
            const distanceText = document.createElement("a-text");
            distanceText.id = `${id}-distance-text`;
            distanceText.setAttribute("value", formatDistance(distance));
            distanceText.setAttribute("color", "white");
            distanceText.setAttribute("align", "center");
            distanceText.setAttribute("position", "0 0.7 0");
            distanceText.setAttribute("scale", "0.8 0.8 0.8");
            distanceText.setAttribute("side", "double");
            marker.appendChild(distanceText);

            entity.appendChild(marker);

            // Set posisi GPS dengan altitude untuk stabilitas
            entity.setAttribute("gps-projected-entity-place", `latitude: ${poi.latitude}; longitude: ${poi.longitude}; altitude: ${poi.altitude || 0}`);

            // Look at camera - membuat objek selalu menghadap pengguna
            entity.setAttribute("look-at", "[gps-projected-camera]");

            // Tambahkan ke container
            container.appendChild(entity);

            // Simpan referensi
            poiEntities[id] = {
              entity,
              marker,
              distanceText,
              distance,
              bearing,
            };

            // Buat indikator jarak di UI
            createDistanceIndicator(id, poi);
          } else {
            // Perbarui entitas yang sudah ada
            const poiData = poiEntities[id];
            poiData.distance = distance;
            poiData.bearing = bearing;

            // Perbarui teks jarak
            const distanceText = document.getElementById(`${id}-distance-text`);
            if (distanceText) {
              distanceText.setAttribute("value", formatDistance(distance));
            }

            // Perbarui indikator jarak di UI
            updateDistanceIndicator(id, poi, distance, bearing);
          }

          // Sesuaikan skala berdasarkan jarak
          updateEntityScale(id, distance);

          // Perbarui path jika diperlukan
          if (shouldUpdatePaths) {
            updatePathToEntity(id, poi, distance, bearing);
          }
        });
      }

      // Memformat jarak untuk tampilan
      function formatDistance(distance) {
        if (distance < 1000) {
          return `${Math.round(distance)} m`;
        } else {
          return `${(distance / 1000).toFixed(1)} km`;
        }
      }

      // Memperbarui skala entitas berdasarkan jarak
      function updateEntityScale(id, distance) {
        const entity = poiEntities[id];
        if (!entity || !entity.marker) return;

        // Hitung skala berdasarkan jarak, inversi yaitu semakin dekat semakin besar
        let scale = CONFIG.minScale + (CONFIG.maxScale - CONFIG.minScale) * (1 - Math.min(Math.max(distance - CONFIG.minDistance, 0) / (CONFIG.maxDistance - CONFIG.minDistance), 1));

        // Terapkan skala ke marker
        entity.marker.setAttribute("scale", `${scale} ${scale} ${scale}`);
      }

      // Membuat atau memperbarui jalur ke entitas
      function updatePathToEntity(id, poi, distance, bearing) {
        // Jika terlalu jauh, jangan tampilkan jalur
        if (distance > CONFIG.visibleDistance) {
          if (pathEntities[id]) {
            pathEntities[id].remove();
            delete pathEntities[id];
          }
          return;
        }

        // Hitung posisi untuk jalur
        const pathLength = Math.min(distance, 50); // Batasi panjang jalur maksimal 50m

        // Hitung arah jalur berdasarkan bearing relatif ke arah kamera
        const relativeBearing = (bearing - deviceHeading + 360) % 360;
        const radianBearing = toRadians(relativeBearing);

        // Jalur (garis) dari pengguna ke POI
        if (!pathEntities[id]) {
          const path = document.createElement("a-entity");
          path.id = `path-${id}`;

          // Buat garis dari posisi kamera
          const line = document.createElement("a-entity");
          line.setAttribute("line", {
            start: { x: 0, y: -1, z: 0 },
            end: {
              x: (Math.sin(radianBearing) * pathLength) / 10,
              y: -1,
              z: (-Math.cos(radianBearing) * pathLength) / 10,
            },
            color: poi.color || "#FFFFFF",
            opacity: 0.6,
            dashed: true,
          });

          path.appendChild(line);

          // Tambahkan ke scene dari posisi kamera
          document.querySelector("a-camera").appendChild(path);

          // Simpan referensi
          pathEntities[id] = path;
        } else {
          // Perbarui jalur yang sudah ada
          const line = pathEntities[id].querySelector("[line]");
          if (line) {
            line.setAttribute("line", {
              start: { x: 0, y: -1, z: 0 },
              end: {
                x: (Math.sin(radianBearing) * pathLength) / 10,
                y: -1,
                z: (-Math.cos(radianBearing) * pathLength) / 10,
              },
              color: poi.color || "#FFFFFF",
              opacity: 0.6,
              dashed: true,
            });
          }
        }
      }

      // Membuat indikator jarak di UI
      function createDistanceIndicator(id, poi) {
        const indicator = document.createElement("div");
        indicator.id = `indicator-${id}`;
        indicator.className = "distance-indicator";
        indicator.style.backgroundColor = poi.color || "#3366FF";
        indicator.textContent = `${poi.name}: ${formatDistance(poiEntities[id].distance)}`;

        distanceIndicatorsContainer.appendChild(indicator);
        distanceIndicators[id] = indicator;

        updateDistanceIndicator(id, poi, poiEntities[id].distance, poiEntities[id].bearing);
      }

      // Memperbarui indikator jarak di UI
      function updateDistanceIndicator(id, poi, distance, bearing) {
        const indicator = distanceIndicators[id];
        if (!indicator) return;

        // Perbarui teks
        indicator.textContent = `${poi.name}: ${formatDistance(distance)}`;

        // Hitung posisi indikator berdasarkan bearing
        const relativeBearing = (bearing - deviceHeading + 360) % 360;
        const radianBearing = toRadians(relativeBearing);

        // Posisikan di tepi layar berdasarkan arah bearing
        const offsetX = Math.sin(radianBearing) * 40;
        const offsetY = -Math.cos(radianBearing) * 20;

        // Posisi di layar - gunakan nilai absolut untuk menghindari keluar dari layar
        const screenWidth = window.innerWidth;
        const screenHeight = window.innerHeight;

        const x = Math.max(60, Math.min(screenWidth - 60, screenWidth / 2 + offsetX));
        const y = Math.max(100, Math.min(screenHeight - 60, screenHeight / 2 + offsetY));

        indicator.style.left = `${x}px`;
        indicator.style.top = `${y}px`;

        // Atur opasitas berdasarkan jarak - semakin jauh semakin transparan
        const opacity = Math.max(0.4, Math.min(1.0, 1 - distance / CONFIG.visibleDistance));
        indicator.style.opacity = opacity;
      }

      // Menangani orientasi perangkat untuk bearing
      function initDeviceOrientation() {
        if (window.DeviceOrientationEvent) {
          window.addEventListener("deviceorientation", function (event) {
            if (event.alpha !== null) {
              // Hitung bearing (arah kompas)
              let heading = 360 - event.alpha;

              // Kompensasi orientasi layar
              const screenOrientation = window.orientation || 0;
              heading = (heading + screenOrientation) % 360;

              // Simpan heading saat ini
              deviceHeading = heading;

              // Update UI
              bearingElement.textContent = `Bearing: ${heading.toFixed(1)}°`;

              // Perbarui indikator arah
              updateDirectionIndicators();
            }
          });
        } else {
          console.warn("DeviceOrientation tidak didukung oleh browser ini.");
        }
      }

      // Perbarui semua indikator arah
      function updateDirectionIndicators() {
        Object.keys(poiEntities).forEach((id) => {
          const poiData = poiEntities[id];
          updateDistanceIndicator(
            id,
            POINTS_OF_INTEREST.find((p) => p.name === poiData.entity.getAttribute("data-poi-name")),
            poiData.distance,
            poiData.bearing
          );

          // Perbarui jalur jika ada
          if (pathEntities[id]) {
            const poiInfo = POINTS_OF_INTEREST.find((p) => p.name === poiData.entity.getAttribute("data-poi-name"));
            updatePathToEntity(id, poiInfo, poiData.distance, poiData.bearing);
          }
        });
      }

      // Perbarui ukuran layar ketika orientasi berubah
      window.addEventListener("resize", function () {
        updateDirectionIndicators();
      });

      // Mulai ketika halaman selesai dimuat
      window.onload = function () {
        initLocationTracking();
        initDeviceOrientation();

        // Atur interval pembaruan untuk menjaga konten tetap segar
        setInterval(() => {
          if (userPosition.latitude && userPosition.longitude) {
            updatePOIEntities();
          }
        }, 1000);
      };
    </script>
  </body>
</html>
